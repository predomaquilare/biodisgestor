#include <Arduino.h>
#include <Wire.h>
#include <Adafruit_ADS1X15.h>

#if defined(ESP32)
  #include <WiFi.h>
#elif defined(ESP8266)
  #include <ESP8266WiFi.h>
#endif
#include <Firebase_ESP_Client.h>

#include <addons/RTDBHelper.h>
#include <addons/TokenHelper.h>

#define WIFI_SSID "IFPB"
#define EAP_USERNAME "20201750008" 
#define EAP_PASSWORD "P3dr0_Gu3rr4" 
#define DATABASE_URL "https://jardim-98db6-default-rtdb.firebaseio.com/"
#define API_KEY "AIzaSyDGp9kLrdYklrb_VVRDWjf8uMaDYZ_5LnM"

FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;
Adafruit_ADS1115 MUX1;
bool signupOK = false;

#define bot1 4
#define SerialX Serial.begin(115200);
#define button(i) pinMode(i, INPUT_PULLUP);
int sensors[4];

unsigned long sendDataPrevMillis = 0;

void readSensors(bool o);
void getsensors();
void upFirebase();
void initialconection();
void checkMotor();

void setup()
{
  SerialX
  button(bot1);
  MUX1.begin();
  initialconection();
  pinMode(2, OUTPUT);
}
 
void loop()
{
  readSensors(0);
  upFirebase();
  //getsensors();
  checkMotor();
}

void readSensors(bool o) {
  for(byte i = 0; i < 4; i++) { 
    sensors[i] = MUX1.readADC_SingleEnded(i);
    if(o == 1) {sensors[i] = map(sensors[i], 12800, 5200, 0, 100);}
  }
}

void getsensors() {
    for(byte i = 0; i < 4; i++) {
      Serial.print(sensors[i]);
      Serial.print(" ");
    }
    Serial.print("\n");
}

void upFirebase() {
  unsigned long prev = 0;
  byte i = 0;
  if (Firebase.ready() && signupOK && (millis() - sendDataPrevMillis >= 5000 || 0))  {
    sendDataPrevMillis = millis();
      while(i < 4) {
        if(millis() - prev >= 500) {
          prev = millis();
          Firebase.RTDB.set(&fbdo, ("/jardim/Sensor" + String(i+1)) , sensors[i]);
          i++;
        }
      }
  }
}

void initialconection() {
  WiFi.begin(WIFI_SSID, WPA2_AUTH_PEAP, EAP_USERNAME, EAP_USERNAME, EAP_PASSWORD);
  Serial.print("Connecting to Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(300);
  } 
  Serial.println();
  Serial.print("Connected with IP: ");
  Serial.println(WiFi.localIP());
  Serial.println();
  Serial.printf("Firebase Client v%s\n\n", FIREBASE_CLIENT_VERSION);
  config.token_status_callback = tokenStatusCallback;
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  config.tcp_data_sending_retry = 1;
  config.timeout.socketConnection = 5000;
  if (Firebase.signUp(&config, &auth, "", "")) {
    Serial.println("Ok");
    signupOK = true;
  }
  else {
    Serial.printf("%s\n", config.signer.signupError.message.c_str());
  }
  fbdo.setBSSLBufferSize(16384, 16384);
  Firebase.reconnectNetwork(true);
  Firebase.begin(&config, &auth);
  Firebase.setDoubleDigits(5);

}

void checkMotor() {
  if(Firebase.RTDB.getBool(&fbdo, "/jardim/motor")) {
    if(fbdo.dataType() == "boolean") {
      digitalWrite(2, !fbdo.boolData());
    }
  }
}

